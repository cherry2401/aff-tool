let extractedLinks = [];

// Đợi DOM load xong
document.addEventListener('DOMContentLoaded', function() {
    console.log('Extension loaded!');
    
    // Gắn event listeners
    const extractBtn = document.getElementById('extractBtn');
    const copyLinksBtn = document.getElementById('copyLinksBtn');
    const replaceBtn = document.getElementById('replaceBtn');
    const copyResultBtn = document.getElementById('copyResultBtn');
    const resetBtn = document.getElementById('resetBtn');
    
    console.log('Buttons:', {extractBtn, copyLinksBtn, replaceBtn, copyResultBtn, resetBtn});
    
    if (extractBtn) extractBtn.addEventListener('click', extractLinks);
    if (copyLinksBtn) copyLinksBtn.addEventListener('click', copyExtractedLinks);
    if (replaceBtn) replaceBtn.addEventListener('click', replaceLinks);
    if (copyResultBtn) copyResultBtn.addEventListener('click', copyResult);
    if (resetBtn) {
        console.log('Reset button found, attaching listener...');
        resetBtn.addEventListener('click', function() {
            console.log('Reset button clicked!');
            resetAll();
        });
    } else {
        console.error('Reset button NOT found!');
    }
});

// Hàm tách link
function extractLinks() {
    console.log('Bắt đầu tách link...');
    const textarea = document.getElementById('originalText');
    const text = textarea.value;
    
    console.log('Nội dung:', text);
    
    if (!text.trim()) {
        console.warn('Chưa có nội dung');
        return;
    }

    // Regex tìm URL
    const urlRegex = /(https?:\/\/[^\s\)]+)/gi;
    const matches = text.match(urlRegex);
    
    console.log('Matches:', matches);
    
    extractedLinks = matches ? matches.map(url => url.trim()) : [];

    // Hiển thị danh sách link
    const linksDisplay = document.getElementById('linksDisplay');
    const linksCount = document.getElementById('linksCount');
    
    if (extractedLinks.length === 0) {
        linksDisplay.className = 'links-display empty';
        linksDisplay.textContent = 'Không tìm thấy link nào';
        linksCount.textContent = 'Link Đã Tách (0)';
        document.getElementById('copyLinksBtn').disabled = true;
        document.getElementById('replaceBtn').disabled = true;
        return;
    }

    linksDisplay.className = 'links-display';
    linksDisplay.innerHTML = extractedLinks.map((link, index) => `
        <div class="link-item">
            <span class="link-badge">${index + 1}</span>
            <span class="link-text">${link}</span>
        </div>
    `).join('');

    linksCount.textContent = `Link Đã Tách (${extractedLinks.length})`;
    document.getElementById('copyLinksBtn').disabled = false;
    document.getElementById('replaceBtn').disabled = false;

    console.log('✅ Đã tách được:', extractedLinks);
}

// Copy link đã tách
function copyExtractedLinks() {
    if (extractedLinks.length === 0) return;

    navigator.clipboard.writeText(extractedLinks.join('\n')).then(() => {
        console.log('✅ Đã copy link');
    }).catch(err => {
        console.error('❌ Lỗi copy:', err);
    });
}

// Thay thế link
function replaceLinks() {
    const originalText = document.getElementById('originalText').value;
    const newLinksText = document.getElementById('newLinksText').value;

    if (!originalText.trim()) {
        console.warn('Chưa có nội dung gốc');
        return;
    }

    if (!newLinksText.trim()) {
        console.warn('Chưa có link mới');
        return;
    }

    // Tách link mới
    const urlRegex = /(https?:\/\/[^\s\)]+)/gi;
    const newLinks = newLinksText.match(urlRegex) || [];

    // Kiểm tra số lượng
    if (newLinks.length !== extractedLinks.length) {
        console.warn(`❌ Số lượng không khớp! Cũ: ${extractedLinks.length}, Mới: ${newLinks.length}`);
        return;
    }

    // Thay thế
    let result = originalText;
    extractedLinks.forEach((oldLink, index) => {
        result = result.replace(oldLink, newLinks[index]);
    });

    // Hiển thị kết quả
    const resultDisplay = document.getElementById('resultDisplay');
    resultDisplay.className = 'result-display';
    resultDisplay.textContent = result;
    document.getElementById('copyResultBtn').disabled = false;

    console.log('✅ Đã thay thế link');
}

// Copy kết quả
function copyResult() {
    const result = document.getElementById('resultDisplay').textContent;
    
    if (result && result !== 'Kết quả sẽ hiển thị ở đây') {
        navigator.clipboard.writeText(result).then(() => {
            console.log('✅ Đã copy kết quả');
        }).catch(err => {
            console.error('❌ Lỗi copy:', err);
        });
    }
}

// Reset tất cả
function resetAll() {
    console.log('Đang reset...');
    
    document.getElementById('originalText').value = '';
    document.getElementById('newLinksText').value = '';
    
    const linksDisplay = document.getElementById('linksDisplay');
    linksDisplay.className = 'links-display empty';
    linksDisplay.textContent = 'Chưa có link nào được tách';
    
    const resultDisplay = document.getElementById('resultDisplay');
    resultDisplay.className = 'result-display empty';
    resultDisplay.textContent = 'Kết quả sẽ hiển thị ở đây';
    
    document.getElementById('linksCount').textContent = 'Link Đã Tách (0)';
    document.getElementById('copyLinksBtn').disabled = true;
    document.getElementById('replaceBtn').disabled = true;
    document.getElementById('copyResultBtn').disabled = true;
    
    extractedLinks = [];
    
    console.log('✅ Đã reset');
}
